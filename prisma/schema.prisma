generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model users {
  id                         String                 @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email                      String                 @unique @db.Citext
  password                   String
  role                       user_role              @default(user)
  balance                    Decimal                @default(0) @db.Decimal(36, 18)
  created_at                 DateTime               @default(now()) @db.Timestamptz(6)
  email_verified             Boolean?               @default(false)
  email_verification_token   String?                @unique @db.VarChar(255)
  email_verification_expires DateTime?              @db.Timestamp(6)
  status                     user_status            @default(active)
  transactions               transactions[]
  withdrawal_whitelists      withdrawal_whitelist[]

  @@index([role], map: "idx_users_role")
  @@index([email_verification_token], map: "idx_email_verification_token")
}

model transactions {
  txhash            String       @id @db.VarChar(100)
  user_id           String       @db.Uuid
  status            tx_status
  blocknumber       BigInt?
  blockhash         String?      @db.VarChar(100)
  blocktimestamp    DateTime?    @db.Timestamp(6)
  from_address      String       @db.VarChar(100)
  to_address        String       @db.VarChar(100)
  amount            Decimal      @db.Decimal(38, 18)
  gasused           BigInt?
  effectivegasprice Decimal?     @db.Decimal(38, 18)
  feepaid           Decimal?     @db.Decimal(38, 18)
  createdat         DateTime?    @default(now()) @db.Timestamp(6)
  direction         tx_direction @default(IN)
  users             users        @relation(fields: [user_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([from_address], map: "idx_transactions_from_address")
  @@index([status], map: "idx_transactions_status")
  @@index([direction], map: "idx_transactions_direction")
  @@index([to_address], map: "idx_transactions_to_address")
  @@index([user_id], map: "idx_transactions_userid")
}

/// This model contains an expression index which requires additional setup for migrations. Visit https://pris.ly/d/expression-indexes for more info.
model withdrawal_whitelist {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id    String   @db.Uuid
  to_address String   @db.VarChar(100)
  created_at DateTime @default(now()) @db.Timestamptz(6)
  updated_at DateTime @default(now()) @updatedAt @db.Timestamptz(6)
  users      users    @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([user_id, to_address], map: "uniq_user_whitelist")
  @@index([user_id], map: "idx_user_whitelist_user")
  @@index([to_address], map: "idx_user_whitelist_address")
}

model deposit_withdraw_events {
  id               String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  type             event_type
  email            String?    @db.Citext
  from_address     String?    @db.VarChar(100)
  to_address       String?    @db.VarChar(100)
  amount           Decimal    @db.Decimal(38, 18)
  timestamp        BigInt
  transaction_hash String     @unique @db.VarChar(100)
  block_number     BigInt
  created_at       DateTime   @default(now()) @db.Timestamptz(6)

  @@index([type], map: "idx_events_type")
  @@index([email], map: "idx_events_email")
  @@index([timestamp], map: "idx_events_timestamp")
  @@index([transaction_hash], map: "idx_events_tx_hash")
}

enum user_role {
  user
  admin
}

enum user_status {
  active
  frozen
}

enum tx_status {
  pending
  success
  failed
}

enum tx_direction {
  IN
  OUT
}

enum event_type {
  DEPOSIT
  WITHDRAW
}
